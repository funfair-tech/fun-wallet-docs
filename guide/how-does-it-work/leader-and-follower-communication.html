<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Leader And Follower Communication | FunWallet Documentation</title>
    <meta name="generator" content="VuePress 1.5.0">
    <link rel="icon" href="/fun-wallet-docs/logo.svg">
    <link rel="manifest" href="/fun-wallet-docs/manifest.json">
    <link rel="apple-touch-icon" href="/fun-wallet-docs/icons/apple-touch-icon-152x152.png">
    <link rel="mask-icon" href="/fun-wallet-docs/icons/safari-pinned-tab.svg" color="#3eaf7c">
    <meta name="description" content="Welcome">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
    <meta name="msapplication-TileColor" content="#000000">
    <link rel="preload" href="/fun-wallet-docs/assets/css/0.styles.d2ddfb65.css" as="style"><link rel="preload" href="/fun-wallet-docs/assets/js/app.f4c58420.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/2.a0d94ea1.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/17.0fc06e43.js" as="script"><link rel="preload" href="/fun-wallet-docs/assets/js/5.c35ce4c3.js" as="script"><link rel="prefetch" href="/fun-wallet-docs/assets/js/10.3f48a5b8.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/11.80799146.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/12.c9e90c03.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/13.e4a5dcfb.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/14.355eb188.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/15.e12ec460.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/16.5742e3d8.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/18.5808ac01.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/19.80a5d59e.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/20.a49817c7.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/21.ce2df6c0.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/22.7612c77c.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/23.1c157430.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/24.04689a5f.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/25.056809c0.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/26.727b7ec0.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/27.065e4d50.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/28.095f1f4b.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/29.1bbd32c9.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/3.115da35b.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/30.a813e3d3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/31.2d3f224a.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/32.3fe15494.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/33.4eeb39a4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/34.6a6d372c.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/35.b6b05392.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/36.afd52f90.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/37.80fac9d7.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/38.9d6c76f1.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/39.7b2ae1e4.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/4.e3251b57.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/40.f92fd921.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/41.553fe969.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/6.28406707.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/7.cf304ae3.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/8.259a090f.js"><link rel="prefetch" href="/fun-wallet-docs/assets/js/9.8a11410d.js">
    <link rel="stylesheet" href="/fun-wallet-docs/assets/css/0.styles.d2ddfb65.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/fun-wallet-docs/" class="home-link router-link-active"><img src="/fun-wallet-docs/logo.svg" alt="FunWallet Documentation" class="logo"> <span class="site-name can-hide">FunWallet Documentation</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/fun-wallet-docs/guide/" class="nav-link router-link-active">
  Guide
</a></div> <a href="https://github.com/funfair-tech/fun-wallet-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/fun-wallet-docs/guide/" class="nav-link router-link-active">
  Guide
</a></div> <a href="https://github.com/funfair-tech/fun-wallet-docs" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Information</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/" aria-current="page" class="sidebar-link">Introduction</a></li><li><a href="/fun-wallet-docs/guide/information/getting-started.html" class="sidebar-link">Getting Started</a></li><li><a href="/fun-wallet-docs/guide/information/browser-support.html" class="sidebar-link">Browser Support</a></li><li><a href="/fun-wallet-docs/guide/information/testing.html" class="sidebar-link">Our Testing</a></li><li><a href="/fun-wallet-docs/guide/information/layouts.html" class="sidebar-link">Layouts</a></li><li><a href="/fun-wallet-docs/guide/information/branding.html" class="sidebar-link">Branding</a></li><li><a href="/fun-wallet-docs/guide/information/kyc.html" class="sidebar-link">KYC</a></li><li><a href="/fun-wallet-docs/guide/information/fiat-gateway.html" class="sidebar-link">Fiat Gateway</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>How Does It Work?</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-authentication-works.html" class="sidebar-link">How Authentication Works?</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/registration.html" class="sidebar-link">Registration</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/login-and-recovery-token-generation.html" class="sidebar-link">Login &amp; Recovery Token Generation</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/recovery.html" class="sidebar-link">Recovery</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/re-authentication.html" class="sidebar-link">Re-authentication</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-is-the-authentication-secure.html" class="sidebar-link">How Is The Authentication Secure?</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-popup-authenticates-leader.html" class="sidebar-link">How The Authenticated Popup Authenticates The Leader ?</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html" aria-current="page" class="active sidebar-link">Leader And Follower Communication</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#introduction" class="sidebar-link">Introduction</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#what-is-a-leader-instance" class="sidebar-link">What Is A Leader Instance</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#what-is-a-follower" class="sidebar-link">What Is A Follower</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#secure-communications-between-the-leader-and-follower" class="sidebar-link">Secure communications between the leader and follower</a></li><li class="sidebar-sub-header"><a href="/fun-wallet-docs/guide/how-does-it-work/leader-and-follower-communication.html#how-is-the-leader-and-follower-communication-service" class="sidebar-link">How is the leader and follower communication service?</a></li></ul></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/how-broadcast-works.html" class="sidebar-link">How Broadcast Works?</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/fun-wallet-sdk.html" class="sidebar-link">FunWallet SDK</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/fun-wallet-ethereum-provider.html" class="sidebar-link">FunWallet Ethereum Provider</a></li><li><a href="/fun-wallet-docs/guide/how-does-it-work/blooms.html" class="sidebar-link">Blooms</a></li></ul></section></li><li><section class="sidebar-group depth-0"><p class="sidebar-heading"><span>Web SDK</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/fun-wallet-docs/guide/web-sdk/installing-sdk.html" class="sidebar-link">Installing FunWallet SDK</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/setting-up-the-sdk-with-project.html" class="sidebar-link">Setting Up The SDK in your Project</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/initialising-the-sdk.html" class="sidebar-link">Initialising The SDK</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/authentication.html" class="sidebar-link">Authentication</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/wallet-ui.html" class="sidebar-link">Show Wallet UI</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/routing.html" class="sidebar-link">Routing And Deep Linking</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/languages.html" class="sidebar-link">Languages</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/approval-modal.html" class="sidebar-link">Approval Modals</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/ethereum-provider.html" class="sidebar-link">Ethereum Provider</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/sdk-methods.html" class="sidebar-link">SDK Methods</a></li><li><a href="/fun-wallet-docs/guide/web-sdk/sdk-event-listeners.html" class="sidebar-link">SDK Event Listeners</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="leader-and-follower-communication"><a href="#leader-and-follower-communication" class="header-anchor">#</a> Leader And Follower Communication</h1> <h2 id="introduction"><a href="#introduction" class="header-anchor">#</a> Introduction</h2> <p>Since the wallet can't trust the dapp hosting the client, it can't pass sensitive data through to the SDK because that is hosted on the dapp and would mean the dapp could get access to that sensitive data like the private key, which would be an unacceptable security compromise. The 'Leader and Follower' solution allows communication between the <code>leader</code> and the <code>follower</code> without the dapp being able to intercept the data, allowing the wallet to have 2 instances of itself running for reasons described below.</p> <p>If iframes are removed from the DOM it kills the instance and when added back to the DOM it reloads itself, also if you move an iframe using JavaScript it also reloads itself - so there is no such thing as <code>magic iframes</code>.</p> <p>As the wallet needs to be authenticated and then never reloaded due to it holding the users private key in memory, this causes a bit of a problem. Front-end apps of today use awesome frameworks like angular &amp; react - so developers want to take advantage of lazy loading and general solid approaches. If you just had one instance which never got removed from the DOM it would only work on a very basic web app hence where <code>leader</code> and <code>follower</code> comes in.</p> <h2 id="what-is-a-leader-instance"><a href="#what-is-a-leader-instance" class="header-anchor">#</a> What Is A Leader Instance</h2> <p>The <code>leader</code> is the authenticated instance which never gets removed from the DOM or moved. The <code>leader</code> is the communication window which speaks to the SDK. This is in charge of spawning up a new <code>follower</code> instance and runs the show. Your dapp will only ever speak to the leader when it does any SDK calls. All event listeners and messages will be sent to the parent from the <code>leader</code>. You <strong>MUST</strong> only ever have <code>1</code> leader and the SDK will throw errors if you ever have more then one.</p> <p>The <code>leader</code> instance will be in a <code>iframe</code> hidden away in the start of the <code>&lt;body&gt;</code> and invisible. Once the user has logged in the event <a href="#authenticationcompleted"><code>authenticationCompleted</code></a> is fired and the leader is completely authenticated. Any sensitive data passed between the leader and the follower is RSA encrypted so nobody can decrypt it, <em>including</em> the dapp. The leader will keep everything in sync going forward (like nonces, blocks etc).</p> <p>You should never use the <code>leader</code> instance to show the standard UI as it doesn't route to certain views as its mainly used for the communication, approval modals, KYC process and player protection. If you want to show any other wallet UI please use a <code>follower</code> instance to do that.</p> <h2 id="what-is-a-follower"><a href="#what-is-a-follower" class="header-anchor">#</a> What Is A Follower</h2> <p>The follower is an instance you can spawn and destroy whenever you want. This is what you would use to show content on the UI for the wallet. You can only ever have <code>1 leader</code> and <code>1 follower</code>, due to synchronisation being essential. This is a fixed limit.</p> <p>You must only ever show this when the <a href="#authenticationcompleted"><code>authenticationCompleted</code></a> event has fired and you know the leader instance is authenticated. You can also check this by using the <a href="#isauthenticated"><code>isAuthenticated</code></a> SDK method. This again is all shown in the wallet integration test app.</p> <h2 id="secure-communications-between-the-leader-and-follower"><a href="#secure-communications-between-the-leader-and-follower" class="header-anchor">#</a> Secure communications between the leader and follower</h2> <p>The leader and the follower communicate using the <a href="https://developer.mozilla.org/en-US/docs/Web/API/Broadcast_Channel_API" target="_blank" rel="noopener noreferrer"><code>Broadcast Channel Api</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> or via cookies. Safari and Edge do not support the native <code>Broadcast Channel Api</code> so they communicate through saving cookies and reading cookies.</p> <img src="/fun-wallet-docs/leader-follower-authentication-flow.png"> <p>As you can see in the above flow all data passed between the instances is encrypted, meaning if someone did get to that data it's useless without the RSA private key. This private key is never exposed and held in memory within the instances.</p> <h2 id="how-is-the-leader-and-follower-communication-service"><a href="#how-is-the-leader-and-follower-communication-service" class="header-anchor">#</a> How is the leader and follower communication service?</h2> <p>üí° Encrypted every message between leader &gt; follower and follower &gt; leader,</p> <p>üí° Even if the dapp could snoop (which it can not) the messages will be a blob of data without the RSA private key which is held in the instances memory, which means its a useless blob of data.
<br>
¬†¬†¬†¬†¬†¬† üí° Dapp can not get to that as its protected by cross site scripting and standard internet security.
<br></p> <p>üí° Broadcast API is something supported in most browsers but Safari and Edge.
<br>
¬†¬†¬†¬†¬†¬† üí° This only can broadcast to it's own domain, for example <code>wallet.funfair.io</code> can only speak to <code>wallet.funfair.io</code> so it‚Äôs never exposed to anyone else.</p> <p>üí° Due to safari we had to write our own broadcast logic for them which uses cookies to read and write values to each instance again protected by the domain.</p> <p>üí° As its client side code is holding the private key in memory there is no physical trace of it anywhere after you refresh, minus the encrypted session data which is useless without all the other encrypted data as its double encrypted. This is also removed when you close the tab.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/funfair-tech/fun-wallet-docs/edit/master/packages/docs/dist/guide/how-does-it-work/leader-and-follower-communication.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/27/2020, 2:19:11 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ‚Üê
      <a href="/fun-wallet-docs/guide/how-does-it-work/how-popup-authenticates-leader.html" class="prev">
        How The Authenticated Popup Authenticates The Leader ?
      </a></span> <span class="next"><a href="/fun-wallet-docs/guide/how-does-it-work/how-broadcast-works.html">
        How Broadcast Works?
      </a>
      ‚Üí
    </span></p></div> </main></div><div class="global-ui"><!----><!----></div></div>
    <script src="/fun-wallet-docs/assets/js/app.f4c58420.js" defer></script><script src="/fun-wallet-docs/assets/js/2.a0d94ea1.js" defer></script><script src="/fun-wallet-docs/assets/js/17.0fc06e43.js" defer></script><script src="/fun-wallet-docs/assets/js/5.c35ce4c3.js" defer></script>
  </body>
</html>
